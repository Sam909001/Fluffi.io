<!DOCTYPE html>
<html lang="en">
<!-- HEAD SECTION REMAINS EXACTLY THE SAME -->
<body class="text-gray-800 dark:text-white">
  <!-- ALL HTML MARKUP REMAINS UNCHANGED -->

  <!-- MODIFIED SCRIPT SECTION -->
  <script>
    let userWalletAddress = null;
    const initialPrice = 0.0001;
    const stages = 15;
    const stageDuration = 1000 * 60 * 60 * 48;
    const startTime = Date.now();

    // Added: Check existing connection on load
    async function checkExistingConnection() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            userWalletAddress = accounts[0];
            updateWalletButton(true);
          }
        } catch (error) {
          console.error('Connection check failed:', error);
        }
      }
    }

    // Modified: Robust connectWallet function
    async function connectWallet() {
      if (!window.ethereum) {
        alert('MetaMask not detected.');
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (accounts.length === 0) return;
        
        // Network validation (replace 0x1 with your chain ID)
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== '0x1') {
          alert('Please connect to Ethereum Mainnet');
          return;
        }

        userWalletAddress = accounts[0];
        updateWalletButton(true);

        // Handle account changes
        window.ethereum.on('accountsChanged', (newAccounts) => {
          userWalletAddress = newAccounts[0] || null;
          updateWalletButton(!!userWalletAddress);
        });

        // Handle network changes
        window.ethereum.on('chainChanged', () => window.location.reload());

      } catch (error) {
        console.error('Connection failed:', error);
        updateWalletButton(false);
        if (error.code === 4001) {
          alert('Connection request rejected');
        } else {
          alert('Connection failed. Please try again.');
        }
      }
    }

    // Added: Unified UI update for wallet state
    function updateWalletButton(isConnected) {
      const button = document.getElementById('walletButton');
      button.textContent = isConnected ? 'Connected' : 'Connect Wallet';
      button.classList.toggle('connected', isConnected);
    }

    // Rest of original functions remain unchanged
    function updateStage() { /* ... */ }
    function updateCountdown() { /* ... */ }
    function buyFluffi() { /* ... */ }
    function stakeFluffi() { /* ... */ }
    function toggleDarkMode() { /* ... */ }

    // Modified initialization
    document.addEventListener('DOMContentLoaded', () => {
      checkExistingConnection(); // Check existing connection
      updateStage();
      updateCountdown();
      setInterval(() => {
        updateStage();
        updateCountdown();
      }, 1000);
    });
  </script>
</body>
</html>
