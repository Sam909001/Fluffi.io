<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>$FLUFFI Presale & Staking</title>
  <meta name="description" content="$FLUFFI is a Solana Layer 2 meme token with presale and staking features. Join the community and earn rewards." />
  <meta name="keywords" content="Fluffi, $FLUFFI, crypto, presale, staking, Solana, meme token" />
  <meta name="author" content="FLUFFI Team" />
  <!-- Added CSP Policy -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self';
                 script-src 'self' 
                   https://cdn.jsdelivr.net 
                   'unsafe-eval' 
                   'wasm-unsafe-eval';
                 connect-src 'self' 
                   https://*.ethers.org 
                   https://bsc-testnet.publicnode.com;
                 style-src 'self' 
                   'unsafe-inline' 
                   https://cdn.jsdelivr.net;">
  <link rel="icon" href="fluffi.jpg" type="image/jpeg">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX');
  </script>
  <style>
    body {
      background: linear-gradient(to bottom, #fff0f5, #fff9e6);
    }
    .timer {
      font-family: monospace;
    }
    .section-title {
      @apply text-2xl font-bold mb-4;
    }
    .dark {
      background: #111827;
      color: white;
    }
    .dark .text-gray-800 {
      color: white !important;
    }
    .dark .bg-white {
      background-color: #1f2937 !important;
    }
    .dark .text-gray-600 {
      color: #d1d5db !important;
    }
    .dark .bg-gray-200 {
      background-color: #374151 !important;
    }
    .dark .text-blue-600 {
      color: #60a5fa !important;
    }
  </style>
</head>
<body class="text-gray-800 dark:text-white">
  <!-- Header -->
  <header class="flex flex-col md:flex-row items-center justify-between px-4 py-3 bg-white dark:bg-gray-900 shadow sticky top-0 z-10">
    <div class="flex items-center gap-3">
      <img src="fluffi.jpg" alt="$FLUFFI Logo" class="w-10 h-10">
      <h1 class="text-xl font-bold">$FLUFFI</h1>
    </div>
    <nav class="flex flex-wrap gap-4 mt-2 md:mt-0 text-sm">
      <a href="#presale" class="hover:underline">Presale</a>
      <a href="#staking" class="hover:underline">Staking</a>
      <a href="#tokenomics" class="hover:underline">Tokenomics</a>
      <a href="#faq" class="hover:underline">FAQ</a>
      <button id="darkModeToggle" class="ml-2 bg-gray-300 hover:bg-gray-400 px-2 rounded">ðŸŒ™</button>
      <button id="walletButton" class="bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded">Connect Wallet</button>
    </nav>
  </header>

  <main class="p-6 max-w-4xl mx-auto">
    <!-- Presale Section -->
    <section id="presale" class="mb-6 p-4 bg-white dark:bg-gray-800 rounded shadow">
      <h2 class="section-title">Presale is Live!</h2>
      <p id="stageInfo" class="mb-2">Stage: 1 / 15</p>
      <p id="priceInfo" class="mb-2">Price: $0.000100</p>
      <p class="mb-2">Referral Bonus: <strong>10%</strong></p>
      <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
        <div class="bg-green-500 h-4 rounded-full transition-all duration-700 ease-in-out" id="progressBar" style="width: 10%"></div>
      </div>
      <p class="mb-4 timer" id="countdown"></p>

      <input type="number" placeholder="Amount in USD" id="amountInput" class="w-full p-2 border rounded mb-2 text-black" />
      <input type="text" placeholder="Referral wallet (optional)" id="refInput" class="w-full p-2 border rounded mb-4 text-black" />
      <button id="buyButton" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">Buy Now</button>
    </section>

    <!-- Claim Section -->
    <section class="p-4 bg-white dark:bg-gray-800 rounded shadow mb-6">
      <h2 class="section-title">Claim $FLUFFI</h2>
      <p class="mb-2">Once the presale ends, you can claim your purchased tokens here.</p>
      <button class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Claim Tokens</button>
    </section>

    <!-- Staking Section -->
    <section id="staking" class="p-4 bg-white dark:bg-gray-800 rounded shadow mb-6">
      <h2 class="section-title">Stake Your $FLUFFI</h2>
      <p class="mb-2">APY: <strong>90%</strong> | Ends at Listing Date</p>
      <input type="number" placeholder="Amount to stake" id="stakeInput" class="w-full p-2 border rounded mb-2 text-black" />
      <button id="stakeButton" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded">Stake</button>
    </section>

    <!-- Tokenomics -->
    <section id="tokenomics" class="p-4 bg-white dark:bg-gray-800 rounded shadow mb-6">
      <h2 class="section-title">Tokenomics</h2>
      <ul class="list-disc pl-5 space-y-1">
        <li>Total Supply: 10,000,000,000 FLUFFI</li>
        <li>Presale: 40%</li>
        <li>Liquidity: 30% (Locked)</li>
        <li>Staking: 20%</li>
        <li>Marketing: 5%</li>
        <li>Team: 5% (Locked)</li>
      </ul>
    </section>

    <!-- FAQ -->
    <section id="faq" class="p-4 bg-white dark:bg-gray-800 rounded shadow mb-6">
      <h2 class="section-title">FAQ</h2>
      <details class="mb-2"><summary>How do I buy $FLUFFI?</summary><p class="pl-4">Connect your wallet, enter amount in USD, and click "Buy Now".</p></details>
      <details class="mb-2"><summary>When does staking end?</summary><p class="pl-4">Staking ends at the official listing date.</p></details>
      <details class="mb-2"><summary>What chains are supported?</summary><p class="pl-4">BNB, ETH, SOL, and USDC.</p></details>
    </section>
  </main>

  <footer class="flex justify-between px-4 py-4 text-sm text-gray-600 dark:text-gray-300">
    <div>Â© 2025 $FLUFFI Token</div>
    <div class="flex gap-4">
      <a href="https://t.me/FLUFFISOLANALAYER2" target="_blank" title="Telegram">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg" alt="Telegram" class="w-5 h-5">
      </a>
      <a href="https://x.com/FLUFFIOFFICIAL" target="_blank" title="Twitter">
        <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/x.svg" alt="Twitter" class="w-5 h-5">
      </a>
    </div>
  </footer>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.8.1/+esm";

    // --- Global Variables ---
    let provider, signer, contract, userWalletAddress = null;
    const contractAddress = "0x60A94bc12d0d4F782Fd597e5E1222247CFb7E297";
    const contractABI = [
      {
        "inputs": [{"internalType": "address", "name": "referrer", "type": "address"}],
        "name": "contribute",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
        "name": "stakeTokens",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    // --- Referral Tracking ---
    const urlParams = new URLSearchParams(window.location.search);
    const refWallet = urlParams.get('ref');
    if (refWallet) {
      localStorage.setItem('fluffiRef', refWallet);
    }

    // --- Leaderboard Simulation ---
    let leaderboard = JSON.parse(localStorage.getItem('fluffiLeaderboard')) || {};

    // --- Init Wallet ---
    async function initWeb3() {
      if (!window.ethereum) {
        alert("MetaMask not detected");
        return;
      }

      await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      userWalletAddress = await signer.getAddress();
      contract = new ethers.Contract(contractAddress, contractABI, signer);
      document.getElementById('walletButton').textContent = userWalletAddress.slice(0, 6) + '...';
      console.log('âœ… Wallet connected:', userWalletAddress);
    }

    // --- Dark Mode Toggle ---
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
    }

    // --- Buy Function ---
    async function buyFluffi() {
      const buyButton = document.getElementById('buyButton');
      buyButton.disabled = true;
      
      try {
        if (!window.ethereum) {
          alert("MetaMask not installed");
          return;
        }

        // Check network (BSC Testnet = 0x61)
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== "0x61") {
          alert("Please switch to BSC Testnet");
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: "0x61" }],
          });
          return;
        }

        const usdAmount = parseFloat(document.getElementById('amountInput').value);
        if (isNaN(usdAmount) {
          alert("Invalid amount");
          return;
        }

        const ethAmount = (usdAmount * 0.0004).toFixed(6); // $1 = 0.0004 BNB
        const ref = document.getElementById('refInput').value || ethers.ZeroAddress;

        const tx = await contract.contribute(ref, {
          value: ethers.parseEther(ethAmount.toString())
        });
        
        alert(`Transaction sent! Hash: ${tx.hash}`);
        await tx.wait();
        alert("Purchase confirmed!");
        
      } catch (error) {
        console.error("Buy failed:", error);
        alert(`Error: ${error.message}`);
      } finally {
        buyButton.disabled = false;
      }
    }

    // --- Stake Function ---
    async function stakeFluffi() {
      const stakeButton = document.getElementById('stakeButton');
      stakeButton.disabled = true;
      
      try {
        if (!userWalletAddress) {
          await initWeb3();
          if (!userWalletAddress) return;
        }

        const amount = document.getElementById('stakeInput').value;
        if (!amount || isNaN(amount)) {
          alert("Invalid amount");
          return;
        }

        const tx = await contract.stakeTokens(ethers.parseUnits(amount, 18));
        alert(`Staking initiated! TX Hash: ${tx.hash}`);
        await tx.wait();
        alert("Staking confirmed!");
        
      } catch (error) {
        console.error("Stake failed:", error);
        alert(`Error: ${error.message}`);
      } finally {
        stakeButton.disabled = false;
      }
    }

    // --- Price + Stage Update ---
    const initialPrice = 0.0001;
    const stages = 15;
    const stageDuration = 1000 * 60 * 60 * 48;
    const startTime = new Date("2025-05-05T12:00:00Z").getTime();

    function updateStage() {
      const now = Date.now();
      const elapsed = now - startTime;
      const stage = Math.min(Math.floor(elapsed / stageDuration), stages - 1);
      const price = (initialPrice * Math.pow(1.05, stage)).toFixed(6);
      document.getElementById('stageInfo').textContent = `Stage: ${stage + 1} / ${stages}`;
      document.getElementById('priceInfo').textContent = `Price: $${price}`;
      document.getElementById('progressBar').style.width = `${((stage + 1) / stages) * 100}%`;
    }

    // --- Countdown Timer ---
    function updateCountdown() {
      const end = startTime + 30 * 24 * 60 * 60 * 1000;
      const left = end - Date.now();
      const days = Math.floor(left / (1000 * 60 * 60 * 24));
      const hours = Math.floor((left / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((left / (1000 * 60)) % 60);
      const seconds = Math.floor((left / 1000) % 60);
      document.getElementById('countdown').textContent = `Ends in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    // --- Render Leaderboard ---
    function renderLeaderboard() {
      const container = document.getElementById('leaderboard');
      if (!container) return;
      container.innerHTML = '<h3 class="text-lg font-bold mb-2">Top Referrers</h3>';
      const sorted = Object.entries(leaderboard).sort((a, b) => b[1] - a[1]).slice(0, 5);
      if (sorted.length === 0) {
        container.innerHTML += '<p class="text-sm text-gray-500">No referrals yet.</p>';
      } else {
        sorted.forEach(([address, amount], index) => {
          container.innerHTML += `<p class="text-sm">${index + 1}. ${address} - $${amount.toFixed(2)}</p>`;
        });
      }
    }

    // --- Initialize ---
    document.addEventListener('DOMContentLoaded', () => {
      updateStage();
      updateCountdown();
      renderLeaderboard();
      setInterval(() => {
        updateStage();
        updateCountdown();
      }, 1000);

      // Event Listeners
      document.getElementById('walletButton').addEventListener('click', initWeb3);
      document.getElementById('buyButton').addEventListener('click', buyFluffi);
      document.getElementById('stakeButton').addEventListener('click', stakeFluffi);
      document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
    });
  </script>
</body>
</html>
