<!DOCTYPE html>
<html lang="en">
<!-- HEAD SECTION REMAINS EXACTLY THE SAME -->
<body class="text-gray-800 dark:text-white">
  <!-- ALL HTML MARKUP REMAINS UNCHANGED -->

  <!-- MODIFIED SCRIPT SECTION -->
  <script>
    let userWalletAddress = null;
    const initialPrice = 0.0001;
    const stages = 15;
    const stageDuration = 1000 * 60 * 60 * 48;
    const startTime = Date.now();

    // 1. Check existing connection safely
    async function checkExistingConnection() {
        try {
            if (window.ethereum?.isConnected?.()) {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    userWalletAddress = accounts[0];
                    updateWalletButton(true);
                }
            }
        } catch (error) {
            console.error('Connection check:', error);
        }
    }

    // 2. Wallet connection with error handling
    async function connectWallet() {
        try {
            if (!window.ethereum) {
                alert('Wallet not detected');
                return;
            }

            const accounts = await window.ethereum.request({ 
                method: 'eth_requestAccounts' 
            });
            
            if (accounts.length === 0) return;

            // Replace '0x1' with your actual chain ID
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            if (chainId !== '0x1') {
                alert('Wrong network - please switch');
                return;
            }

            userWalletAddress = accounts[0];
            updateWalletButton(true);

        } catch (error) {
            console.error('Connection failed:', error);
            updateWalletButton(false);
            alert(error.message || 'Connection error');
        }
    }

    // 3. Safe UI update
    function updateWalletButton(isConnected) {
        const button = document.getElementById('walletButton');
        if (button) {
            button.textContent = isConnected ? 'Connected' : 'Connect Wallet';
            button.classList.toggle('connected', isConnected);
        }
    }

    // 4. Original functions remain unchanged
    function updateStage() {
        const now = Date.now();
        const elapsed = now - startTime;
        const stage = Math.min(Math.floor(elapsed / stageDuration), stages - 1);
        const price = (initialPrice * Math.pow(1.05, stage)).toFixed(6);
        document.getElementById('stageInfo').textContent = `Stage: ${stage + 1} / ${stages}`;
        document.getElementById('priceInfo').textContent = `Price: $${price}`;
        document.getElementById('progressBar').style.width = `${((stage + 1) / stages) * 100}%`;
    }

    function updateCountdown() { 
        /* Keep original implementation */ 
    }

    // 5. Initialize safely
    document.addEventListener('DOMContentLoaded', () => {
        checkExistingConnection();
        updateStage();
        updateCountdown();
        setInterval(() => {
            updateStage();
            updateCountdown();
        }, 1000);
    });
</script>
</body>
</html>
