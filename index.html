<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FLUFFI Presale</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-white text-black dark:bg-gray-900 dark:text-white">

  <!-- Your presale content here -->
  <div>
    <h1>FLUFFI Presale</h1>
    <p id="stageInfo"></p>
    <p id="priceInfo"></p>
    <input type="number" id="amountInput" placeholder="Amount in USD" class="text-black" />
    <input type="text" id="refInput" placeholder="Referrer (optional)" />
    <button id="buyButton">Buy FLUFFI</button>
    <button id="walletButton" onclick="connectWallet()">Connect Wallet</button>
    <p id="countdown"></p>
    <div id="leaderboard"></div>
  </div>

  <!-- Your entire script goes here -->
  <script>
    let userWalletAddress = null;
    const initialPrice = 0.0001;
    const stages = 15;
    const stageDuration = 1000 * 60 * 60 * 48;
    const startTime = new Date("2025-05-05T12:00:00Z").getTime();

    const contractAddress = "0x60A94bc12d0d4F782Fd597e5E1222247CFb7E297";
    const contractABI = [/* your ABI goes here */];

    let signer, contract;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          userWalletAddress = await signer.getAddress();
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          document.getElementById('walletButton').textContent = 'Connected';
        } catch (error) {
          alert('Wallet connection denied.');
        }
      } else {
        alert('MetaMask not detected.');
      }
    }

    function updateStage() {
      const now = Date.now();
      const elapsed = now - startTime;
      const stage = Math.min(Math.floor(elapsed / stageDuration), stages - 1);
      const price = (initialPrice * Math.pow(1.05, stage)).toFixed(6);
      document.getElementById('stageInfo').textContent = `Stage: ${stage + 1} / ${stages}`;
      document.getElementById('priceInfo').textContent = `Price: $${price}`;
    }

    function updateCountdown() {
      const end = startTime + 30 * 24 * 60 * 60 * 1000;
      const left = end - Date.now();
      const days = Math.floor(left / (1000 * 60 * 60 * 24));
      const hours = Math.floor((left / (1000 * 60 * 60)) % 24);
      const minutes = Math.floor((left / (1000 * 60)) % 60);
      const seconds = Math.floor((left / 1000) % 60);
      document.getElementById('countdown').textContent = `Ends in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    // --- Referral Tracking ---
    const urlParams = new URLSearchParams(window.location.search);
    const refWallet = urlParams.get('ref');
    if (refWallet) {
      localStorage.setItem('fluffiRef', refWallet);
    }

    // --- Simulated Leaderboard Data ---
    let leaderboard = JSON.parse(localStorage.getItem('fluffiLeaderboard')) || {};

    // --- Render Leaderboard ---
    function renderLeaderboard() {
      const container = document.getElementById('leaderboard');
      container.innerHTML = '<h3 class="text-lg font-bold mb-2">Top Referrers</h3>';
      const sorted = Object.entries(leaderboard)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      if (sorted.length === 0) {
        container.innerHTML += '<p class="text-sm text-gray-500">No referrals yet.</p>';
      } else {
        sorted.forEach(([address, amount], index) => {
          container.innerHTML += `<p class="text-sm">${index + 1}. ${address} - $${amount.toFixed(2)}</p>`;
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Apply referral
      const savedRef = localStorage.getItem('fluffiRef');
      if (savedRef) {
        const refInput = document.getElementById('refInput');
        if (refInput) {
          refInput.value = savedRef;
        }
      }

      updateStage();
      updateCountdown();
      renderLeaderboard();
      setInterval(() => {
        updateStage();
        updateCountdown();
      }, 1000);

      const amountInput = document.getElementById('amountInput');
      const buyButton = document.getElementById('buyButton');

      if (amountInput && buyButton) {
        buyButton.addEventListener('click', async () => {
          const amount = parseFloat(amountInput.value);
          const ref = document.getElementById('refInput').value || localStorage.getItem('fluffiRef') || ethers.constants.AddressZero;

          if (!signer || !contract) {
            alert('Please connect your wallet first.');
            return;
          }

          if (isNaN(amount) || amount <= 0) {
            alert('Please enter a valid amount.');
            return;
          }

          try {
            const valueInWei = ethers.utils.parseEther(amount.toString());
            const tx = await contract.contribute(ref, { value: valueInWei });
            await tx.wait();
            alert('Purchase successful!');
          } catch (err) {
            console.error('Transaction failed:', err);
            alert('Transaction failed. See console for details.');
          }
        });
      }
    });
  </script>
</body>
</html>
